# Workflow (Правила работы ИИ-агента)

Этот документ задаёт единые правила работы ИИ-агента над проектом `@flowscape-ui/canvas-react`. Цель — обеспечить последовательное выполнение всех этапов, строгую проверку качества, прозрачную коммуникацию с пользователем и соответствие документам: `doc/tasklist.md`, `doc/idea.md`, `doc/vision.md`.

## 1) Главные принципы

- **Последовательность и контроль переходов.** Этапы и подэтапы выполняются строго по порядку, как в `doc/tasklist.md`. Переход к следующему — только после тестов и явного подтверждения пользователя.
- **Согласование намерений.** Перед изменениями агент объясняет план: что будет сделано, в каком объёме, какие файлы затронет, какие проверки пройдут.
- **Прозрачность реализации.** После работ агент кратко докладывает: что реализовано, где находится код, как это работает, как проверить.
- **Тестирование на каждом шаге.** Каждый подэтап сопровождается проверками (unit/integration/E2E по мере появления инфраструктуры). Нельзя двигаться дальше при падающих тестах.
- **Соответствие идее и видению.** Любые спорные решения сверять с `doc/idea.md` и `doc/vision.md`. При несовпадении — уточнять у пользователя.
- **Безопасность и секреты.** Соблюдать правила из плана безопасности (не коммитить секреты, ограничивать содержимое пакета, проверять утечки).

## 2) Источники истины

- `doc/tasklist.md` — единый бэклог с этапами, статусами и критериями.
- `doc/idea.md` — базовая идея и ценность продукта (ориентир для приоритизации и UX).
- `doc/vision.md` — целевая архитектура и дорожная карта высокого уровня.

## 3) Канонический цикл работы по каждому запросу пользователя

1. **Синхронизация контекста**
   - Просмотреть актуальные файлы: `doc/tasklist.md`, `doc/idea.md`, `doc/vision.md`.
   - Уточнить текущий активный этап/задачу и статус (pending/in_progress/completed).
2. **Планирование**
   - Сформулировать короткий план работ и критерии готовности для подэтапа.
   - Перечислить затрагиваемые файлы/директории (например, `src/index.ts`, `.github/workflows/ci.yml`).
   - Описать тесты, которые будут добавлены/запущены.
3. **Подтверждение**
   - Запросить у пользователя подтверждение плана, если план включает переход на новый подэтап/этап, значимые правки или неоднозначности.
4. **Реализация**
   - Вносить минимально достаточные изменения согласно плану.
   - Поддерживать чистоту коммитов (логическая атомарность), соблюдать конвенции.
5. **Тестирование**
   - Запускать проверку типов, линт, unit/integration тесты; E2E — когда появятся.
   - В случае ошибок — остановиться, задокументировать причину, предложить фикс, повторить тесты.
6. **Демонстрация результата**
   - Кратко перечислить изменённые файлы, основные решения и как воспроизвести результат (команды запуска/сборки/просмотра).
7. **Обновление документации и задач**
   - Обновить статусы в `doc/tasklist.md` при необходимости.
   - Обновить TODO-лист рабочего процесса (в IDE) — отметить выполненное, указать следующий шаг.
8. **Ворота перехода**
   - Запросить у пользователя явное подтверждение перехода к следующему подэтапу/этапу.

## 4) Требования к тестам и качеству

- **TypeCheck:** `tsc --noEmit` должен проходить без ошибок.
- **Сборка:** `bun run build` должна завершаться успешно; артефакты — в `dist/`.
- **Unit/Integration:** покрывают ключевую логику этапа, описаны кратко в отчёте.
- **E2E (когда настроен Playwright):** хотя бы smoke сценарии для навигации/зума и критических UX-путей.
- **CI:** PR должен проходить CI; перед переходом к следующему этапу — зелёный статус.

## 5) Коммуникация с пользователем (шаблон ответа)

- **[Цель]** кратко: какая подзадача решается.
- **[План]** пункты работ и затрагиваемые файлы.
- **[Изменения]** что именно реализовано.
- **[Тесты]** какие тесты/проверки запускались и их результат.
- **[Как проверить]** команды, ссылки (например, Storybook/Pages), что посмотреть.
- **[Следующий шаг]** что предлагается делать дальше и запрос подтверждения.

## 6) Соответствие дорожной карте (doc/tasklist.md)

- Выполнять задачи в порядке, указанном в `doc/tasklist.md` (MVP-0.1 → 0.2 → Beta-0.3 → 0.4 и т.д.).
- Каждая задача имеет критерии готовности — применять их как «Definition of Done».
- Если этап требует инфраструктуры (например, Storybook, CI/CD), сначала поднимать инфраструктуру, затем фичи.

## 7) Безопасность и публикация

- Не коммитить `.env`, `.npmrc`, реальные токены; хранить только шаблоны (`.env.example`).
- Контент пакета ограничивать `package.json#files` и верифицировать `npm pack --dry-run`.
- В workflow не логировать секреты; права токенов — минимально необходимые.

## 8) Эскалации и неопределённости

- При неполноте требований — задать уточняющие вопросы до изменений.
- При конфликте между `doc/idea.md` и `doc/vision.md` — зафиксировать расхождение, предложить варианты и запросить решение у пользователя.

---

Следуя этому процессу, агент обеспечивает последовательную, проверяемую и согласованную с пользователем реализацию проекта. Все переходы между подэтапами происходят только после тестирования и явного подтверждения пользователя. Отвечай на запросы пользователя на русском языке.
